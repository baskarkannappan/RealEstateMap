@using RealEstateMap.Models

<div class="house-list-grid" role="list">
    @if (Houses.Count == 0)
    {
        <div class="card empty-results-card border-0 shadow-sm" role="status">
            <div class="card-body">
                <h5 class="card-title mb-2">No matching results</h5>
                <p class="text-muted mb-1">Try zooming out</p>
                <p class="small mb-0"><span class="text-muted">@GeolocationStatus</span></p>
            </div>
        </div>
    }
    else
    {
        @foreach (var house in Houses)
        {
            var price = BuildPrice(house);
            var beds = BuildBeds(house);
            var baths = BuildBaths(house);
            var sqft = BuildSqft(house);
            var hasVideo = HasVideo(house);

            <article class="card house-card border-0 shadow-sm" role="listitem">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start gap-2">
                        <div>
                            <div class="house-price fw-bold">@price</div>
                            <div class="house-address">@house.Address</div>
                            <div class="house-neighborhood text-muted">@NeighborhoodText(house)</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary" @onclick="() => OnSelect.InvokeAsync(house)">
                            View
                        </button>
                    </div>

                    <div class="d-flex align-items-center gap-2 mt-2">
                        <span class="badge rounded-pill text-bg-light">@PostedAgo(house)</span>
                        @if (hasVideo)
                        {
                            <span class="badge rounded-pill text-bg-danger">Video</span>
                        }
                    </div>

                    <div class="house-stats mt-2">
                        <span>@beds bd</span>
                        <span>@baths ba</span>
                        <span>@sqft sqft</span>
                    </div>

                    <p class="text-muted small mb-0 mt-2">@MlsAndBroker(house)</p>
                </div>
            </article>
        }
    }
</div>

@code {
    [Parameter]
    public IReadOnlyList<HouseLocation> Houses { get; set; } = [];

    [Parameter]
    public double? CenterLat { get; set; }

    [Parameter]
    public double? CenterLng { get; set; }

    [Parameter]
    public EventCallback<HouseLocation> OnSelect { get; set; }

    [Parameter]
    public string GeolocationStatus { get; set; } = "Geolocation: Checking...";

    private static int StableHash(HouseLocation house)
    {
        var key = string.IsNullOrWhiteSpace(house.Id)
            ? $"{house.Address}-{house.PostalCode}-{house.City}"
            : house.Id;

        return Math.Abs(key.GetHashCode());
    }

    private static string BuildPrice(HouseLocation house)
    {
        var hash = StableHash(house);
        var value = 200_000 + (hash % 1_300_000);
        return $"${value:N0}";
    }

    private static int BuildBeds(HouseLocation house) => (StableHash(house) % 5) + 1;

    private static decimal BuildBaths(HouseLocation house) => Math.Round(((StableHash(house) % 6) + 2) / 2m, 1);

    private static int BuildSqft(HouseLocation house) => 750 + (StableHash(house) % 3_600);

    private static bool HasVideo(HouseLocation house) => StableHash(house) % 2 == 0;

    private static string NeighborhoodText(HouseLocation house)
    {
        if (string.IsNullOrWhiteSpace(house.City))
        {
            return "Banbury-Don Mills House For Sale";
        }

        return $"{house.City} House For Sale";
    }

    private static string PostedAgo(HouseLocation house)
    {
        var days = (StableHash(house) % 7) + 1;
        return $"{days}d ago";
    }

    private static string MlsAndBroker(HouseLocation house)
    {
        var hash = StableHash(house);
        var mls = $"MLS#{100000 + (hash % 899999)}";
        return $"{mls} | Brokerage: RealEstateMap Partners";
    }
}
