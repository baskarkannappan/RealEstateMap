@using System.Linq
@using Microsoft.AspNetCore.Components
@using Markdig
@using RealEstateMap.Models

<section class="list-section">
    <div class="list-section-header">
        <div>
            <h2 class="h5 mb-1">Properties For Sale</h2>
            <p class="text-muted small mb-0">@Houses.Count results found in this area</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            @if (TotalPages > 1)
            {
                <span class="small text-muted d-none d-sm-inline">Page @CurrentPage of @TotalPages</span>
            }
        </div>
    </div>

    @if (!PagedHouses.Any())
    {
        <div class="card empty-results-card border-0 shadow-sm mt-4 p-5 text-center" role="status">
            <div class="card-body">
                <i class="oi oi-warning mb-3 text-warning" style="font-size: 2rem;"></i>
                <h5 class="card-title mb-2">No matching results</h5>
                <p class="text-muted mb-1">Try zooming out or adjusting your filters</p>
                <p class="small mb-0"><span class="text-muted">@GeolocationStatus</span></p>
            </div>
        </div>
    }
    else
    {
        <div class="house-list-grid" role="list">
            @foreach (var house in PagedHouses)
            {
                var price = BuildPrice(house);
                var beds = BuildBeds(house);
                var baths = BuildBaths(house);
                var sqft = BuildSqft(house);
                var type = BuildHomeType(house);
                var added = BuildAddedText(house);
                var hue = BuildPhotoHue(house);
                var hasVideo = HasVideo(house);

                <article class="card house-card house-card-modern" role="listitem">
                    <div class="house-card-media" style="--photo-hue: @hue">
                        <div class="house-media-top">
                            <span class="media-tag">For Sale</span>
                            <button type="button" class="icon-btn" aria-label="Save listing">
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M12 20.8l-1.4-1.3C5.4 15 2 11.9 2 8.2 2 6 3.7 4.2 6 4.2c1.6 0 3.2.8 4 2.1.8-1.3 2.4-2.1 4-2.1 2.3 0 4 1.8 4 4 0 3.7-3.4 6.8-8.6 11.3L12 20.8z" />
                                </svg>
                            </button>
                        </div>
                        <div class="house-media-bottom">
                            <div class="media-stats">
                                <span>
                                    <svg viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M4 11h16v6H4zM6 9V7a3 3 0 013-3h6a3 3 0 013 3v2" />
                                    </svg>
                                    @beds
                                </span>
                                <span>
                                    <svg viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M6 12h12v6H6zM8 10V7a4 4 0 018 0v3" />
                                    </svg>
                                    @baths
                                </span>
                                <span>
                                    <svg viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M4 4h16v16H4zM4 9h16M9 4v16" />
                                    </svg>
                                    @sqft
                                </span>
                                <span class="media-type">@type</span>
                            </div>
                            <button type="button" class="icon-btn" aria-label="View details" @onclick="() => OpenDetailsAsync(house)">
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M12 4a8 8 0 100 16 8 8 0 000-16zm0 5a1 1 0 110 2 1 1 0 010-2zm1.5 7h-3v-1.5h1v-2h-1V11h2v3.5h1V16z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="card-body house-card-body">
                        <div class="house-price-row">
                            <div class="house-price">@price</div>
                            <span class="house-pill">For Sale</span>
                        </div>
                        <div class="house-address h6 mb-1">@house.Address</div>
                        <div class="house-neighborhood small text-muted">@NeighborhoodText(house)</div>

                        <div class="mt-auto pt-3 border-top d-flex justify-content-between align-items-center">
                            <span class="house-added small">@added</span>
                            @if (hasVideo)
                            {
                                <span class="house-chip">Video Tour</span>
                            }
                        </div>
                    </div>
                </article>
            }
        </div>

        @if (TotalPages > 1)
        {
            <div class="list-pagination mt-4 d-flex flex-column flex-sm-row justify-content-between align-items-center py-3 border-top">
                <div class="pagination-summary mb-3 mb-sm-0">
                    <span class="small text-muted">Showing @((CurrentPage-1)*PageSize + 1) to @(Math.Min(CurrentPage*PageSize, Houses.Count)) of @Houses.Count results</span>
                </div>
                <nav aria-label="Page navigation">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => SetPage(CurrentPage - 1)" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </button>
                        </li>
                        @for (int i = 1; i <= TotalPages; i++)
                        {
                            var pageNum = i;
                            <li class="page-item @(CurrentPage == pageNum ? "active" : "")">
                                <button class="page-link" @onclick="() => SetPage(pageNum)">@pageNum</button>
                            </li>
                        }
                        <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="() => SetPage(CurrentPage + 1)" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    }
</section>

@if (ShowDetailsModal)
{
    <div class="modal fade show d-block detail-modal" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-header border-bottom-0">
                    <div>
                        <h5 class="modal-title h4">Property details</h5>
                        @if (SelectedHouse is not null)
                        {
                            <p class="text-muted small mb-0">@SelectedHouse.Address, @SelectedHouse.City</p>
                        }
                    </div>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body py-0">
                    <div class="markdown-content">@((MarkupString)DetailHtml)</div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light" @onclick="CloseDetailsModal">Close</button>
                    <button type="button" class="btn btn-primary px-4" @onclick="CloseDetailsModal">Schedule tour</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    [Parameter]
    public IReadOnlyList<HouseLocation> Houses { get; set; } = [];

    [Parameter]
    public double? CenterLat { get; set; }

    [Parameter]
    public double? CenterLng { get; set; }

    [Parameter]
    public EventCallback<HouseLocation> OnSelect { get; set; }

    [Parameter]
    public string GeolocationStatus { get; set; } = "Geolocation: Checking...";

    [Parameter]
    public int PageSize { get; set; } = 6;

    private int CurrentPage { get; set; } = 1;
    private int TotalPages => (int)Math.Ceiling((double)Houses.Count / PageSize);

    private IEnumerable<HouseLocation> PagedHouses => Houses
        .Skip((CurrentPage - 1) * PageSize)
        .Take(PageSize);

    private bool ShowDetailsModal;
    private HouseLocation? SelectedHouse;

    private static readonly MarkdownPipeline MarkdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();

    private static readonly string DetailMarkdown = @"
# Listing Summary

**Status:** Active  
**MLS:** RE-482931  
**Last Updated:** 2 days ago  

## Highlights
- Renovated kitchen with quartz counters
- Walk score 89 | Transit score 76
- 2-car garage + EV-ready outlet

## Feature Matrix
| Category | Details |
| --- | --- |
| Heating | Forced air + smart thermostat |
| Cooling | Central air |
| Roof | Architectural shingles (2019) |
| Exterior | Brick + cedar siding |
| HOA | $210 / month |

## Inspection Notes
1. Foundation: no visible cracking
2. Roof: 70% life remaining
3. Windows: double-pane, low-e

## Nearby
- 6 min to Central Park
- 0.4 mi to Blue Line
- Top-rated elementary within 1.2 mi

## Offer Guidance
> Competitive area. Pre-approval strongly recommended.

```text
Projected mortgage (20% down)
Rate: 6.45% | Term: 30yr
Est. payment: $3,420 / mo
```
";

    private static readonly string DetailHtml = Markdown.ToHtml(DetailMarkdown, MarkdownPipeline);

    protected override void OnParametersSet()
    {
        // Reset to first page when houses change (e.g. during search)
        CurrentPage = 1;
    }

    private void SetPage(int page)
    {
        if (page >= 1 && page <= TotalPages)
        {
            CurrentPage = page;
            StateHasChanged();
        }
    }

    private async Task OpenDetailsAsync(HouseLocation house)
    {
        SelectedHouse = house;
        ShowDetailsModal = true;
        await OnSelect.InvokeAsync(house);
    }

    private void CloseDetailsModal()
    {
        ShowDetailsModal = false;
        SelectedHouse = null;
    }

    private static int StableHash(HouseLocation house)
    {
        var key = string.IsNullOrWhiteSpace(house.Id)
            ? $"{house.Address}-{house.City}"
            : house.Id;

        return Math.Abs(key.GetHashCode());
    }

    private static string BuildPrice(HouseLocation house)
    {
        var hash = StableHash(house);
        var value = 200_000 + (hash % 1_300_000);
        return $"${value:N0}";
    }

    private static int BuildBeds(HouseLocation house) => (StableHash(house) % 5) + 1;

    private static decimal BuildBaths(HouseLocation house) => Math.Round(((StableHash(house) % 6) + 2) / 2m, 1);

    private static int BuildSqft(HouseLocation house) => 750 + (StableHash(house) % 3_600);

    private static bool HasVideo(HouseLocation house) => StableHash(house) % 2 == 0;

    private static string NeighborhoodText(HouseLocation house)
    {
        if (string.IsNullOrWhiteSpace(house.City))
        {
            return "Banbury-Don Mills House For Sale";
        }

        return $"{house.City} House For Sale";
    }

    private static string PostedAgo(HouseLocation house)
    {
        var days = (StableHash(house) % 7) + 1;
        return $"{days}d ago";
    }

    private static string BuildHomeType(HouseLocation house)
    {
        var types = new[]
        {
            "Row/Townhouse",
            "Detached",
            "Att/Row/Townhouse",
            "Semi-Detached",
            "Condo",
            "Bungalow"
        };
        return types[StableHash(house) % types.Length];
    }

    private static string BuildAddedText(HouseLocation house)
    {
        var hours = (StableHash(house) % 10) + 1;
        return $"Added {hours} hours ago";
    }

    private static int BuildPhotoHue(HouseLocation house) => StableHash(house) % 360;

    private static string MlsAndBroker(HouseLocation house)
    {
        var hash = StableHash(house);
        var mls = $"MLS#{100000 + (hash % 899999)}";
        return $"{mls} | Brokerage: RealEstateMap Partners";
    }
}
